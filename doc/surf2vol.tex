\pagebreak	
\subsection{typSurf2Vol}

\subsubsection{Description}

\texttt{Surf2Vol} is a wrapper class to access HOS Ocean and NWT class. HOS-Ocean and NWT classes have the similar class structures but only reconstruction schemes and definition of meshes are slightly different. The reconstructed wave fields by two HOS classes are saved in each HOS mesh class which is derived class from base HOS mesh class. By using this mesh pointer, \texttt{Surf2Vol} class can access both HOS reconstructed wave fields. It is reminded that the direct access to the HOS wave fields is possible on HOS simulation time and grid by only HOS mesh pointer to prevent misuse of HOS wave data. 

\texttt{Surf2Vol} class structure is depicted in Fig. \ref{fig:surf2VolStructure}. \texttt{Surf2Vol} class contains \texttt{HOSOceanSurf2Vol} and \texttt{HOSNWTSurf2Vol} classes. When the function is called, it calls the sub-class function distiguished by HOS type. 

\vspace{0.5cm}
{
	\begin{figure} [H]
		\centering
		\includegraphics[scale=0.78]{images/c1.structure/"Surf2VolClassStructure".png}
		\vspace{0.5cm}
		\caption{\texttt{Surf2Vol} class structure}
		\label{fig:surf2VolStructure}
	\end{figure}
}

\pagebreak

\texttt{hosNWTSurf2Vol} and \texttt{hosOceanSurf2Vol} classes reconstruct the HOS wave fields from the result file of HOS by using the $H_2$ operator (inverse FFTs). Wave reconstruction and HOS wave theory is well explained in \cite{ducrozet2007} and \cite{ducrozet2012}. Each class reconstruct the wave fields on the derived HOS mesh class.

HOS wave theory is based on the superposition of modes satisfying the Laplace equation, sea bottom and free surface boundary condition basically. The vertical profile of the mode function is usually given as the exponential or hyperbolic functions. The vertical profile could magnify the local properties when the number of modes is increased and the wave steepness is signigicantly high. Those behaviors ususally happens above the $z=0$. It is resulted from the amplitudes reduction is not as much decreasing with the number of modes. Therefore those mathematical formulation gives the unnatural values. To prevent those things, the criterion to cut the local mode contribution above the $z=0$ is introduced as \eqref{eq:fnzCriterion}. 

\vspace{1em}
{
	\begin{equation}
	\label{eq:fnzCriterion}
	f_{mn}(z) = \begin{cases}
	\dfrac{\cosh k_{mn}(z+H)}{\cosh k_{mn}H}  &  \text{if} \quad f_{mn}(z) < C_{f(z)} \\
	C_{f(z)}  &  \text{if} \quad f_{mn}(z) \geq C_{f(z)}
	\end{cases}
	\end{equation}
	\newline
	\centering
	where
	\begin{equation*}
	k_{mn}	\text{ : HOS mode wave number \quad  $z$ : HOS z-coordinates \quad $H$ :  water depth}
	\end{equation*} 
	\begin{equation*}
	C_{f(z)}  \text{ : $f_{mn}(z)$ function criterion value (default = 10) }
	\end{equation*}
}

The parameter $C_{f(z)}$ is set to be 10 in \texttt{Grid2Grid} as a defualt value. If the local wave velocities generated by \texttt{Grid2Grid} are not sufficient, the parameter can be changed. The parameter is defined in \texttt{modGrid2GridGeneral.f90} as a \texttt{FNZ\_VALUE}.

HOS result file only contains the mode amplitudes computed at each HOS simulation time. The volumic grid should be generated and the wave fields are reconstructed on this grid. The generated volumic grid is used as a background grid for the interpolation. To constuct the HOS grid, following information should be given when \texttt{surf2vol} class is initialised.

\vspace*{0.5em}
\hspace{0.5 cm} $\circ$ \texttt{zMin}, \texttt{zMax}

\hspace{0.5 cm} $\circ$ \texttt{nZMin}, \texttt{nZMax}

\hspace{0.5 cm} $\circ$ \texttt{nZMinRatio}, \texttt{nZMaxRatio} [Optional]

\pagebreak

where \texttt{zMin} and \texttt{zMax} is used to set $z$-directional domain length and it should have the negative and positive value. \texttt{nZMin} and \texttt{nZMax} are the number of $z$-directional grid. It is recommended to have at least 50-100 for the sufficient interpolation. If the number of grid points is not sufficient, the interpolated values could be strange due to the vertical profile of $f_{mn}(z)$. \texttt{nZMinRatio} and \texttt{nZMaxRatio} are the ratio of maximum and minumum height of grid (${\Delta z_{max}}/{\Delta z_{min}} $). Minimum grid is located at $z=0$. Those are optional values set to be 3 as default. The generated HOS grid is automatically saved whe \texttt{surf2vol} class is initialised. And it is visualized by using ParaView. The VTK file is located at VTK/Grid2Grid/surf2volMesh.vtk.

\pagebreak
\subsubsection{Class (Type)}

\textbf{Class} : \texttt{Surf2Vol}

\hspace{0.5 cm} -- Data :

\hspace{1.0 cm} $\circ$ \texttt{hosNWTSurf2Vol\_} : HOS-NWT Surf2Vol Class

\hspace{1.0 cm} $\circ$ \texttt{hosOceanSurf2Vol\_} : HOS-Ocean Surf2Vol Class

\hspace{1.0 cm} $\circ$ \texttt{ptrHOSMesh\_} : HOS Mesh Pointer\\

\hspace{0.5 cm} -- Functionality :

\hspace{1.0 cm} $\circ$ \texttt{initialize} : Initialise HOS Surf2Vol class

\hspace{1.0 cm} $\circ$ \texttt{correct} : Update HOS wave fields

\hspace{1.0 cm} $\circ$ \texttt{destroy} : Class desroyer\\    

\vspace{0.1cm}

\textbf{Class} : \texttt{HOSOcean} and \texttt{HOSNWT}

\hspace{0.5 cm} -- Data :

\hspace{1.0 cm} $\circ$ \texttt{HOSfile} : HOS result file (\texttt{modes\_HOS\_SWENSE.dat}) or \texttt{modes\_HOS\_SWENSE.hdf5}

\hspace{1.0 cm} $\circ$ \texttt{HOSmode} : HOS Ocean or NWT modes

\hspace{1.0 cm} $\circ$ \texttt{HOSmesh} : HOS Ocean or NWT mesh

\hspace{1.0 cm} $\circ$ \texttt{HOSfftw} : HOS FFT class for $H_2$ operator \\

\hspace{0.5 cm} -- Public Functionality :

\hspace{1.0 cm} $\circ$ \texttt{initialize} : Initialise HOS Ocean or NWT Surf2Vol

\hspace{1.0 cm} $\circ$ \texttt{correct} : Update HOS Ocean or NWT wave fields

\hspace{1.0 cm} $\circ$ \texttt{destroy} : Class desroyer\\

\hspace{0.5 cm} -- Private Functionality :

\hspace{1.0 cm} $\circ$ \texttt{init\_read\_mod} : Read HOS number of modes and allocate dynamic array

\hspace{1.0 cm} $\circ$ \texttt{read\_mod} : Read HOS modes at given HOS time index

\hspace{1.0 cm} $\circ$ \texttt{buildGlobalMesh} : Build HOS mesh with the given HOS construction parameter

\hspace{1.0 cm} $\circ$ \texttt{reconstuctionFFTs} : Reconstruct the wave fields by $H_2$ operator \\

\subsubsection{How to use}

\hspace{0.5 cm} -- Initialise \texttt{Surf2Vol}

\begin{lstlisting}[language={[95]Fortran}]

Call hosS2V%initialize(hosType, filePath, zMin, zMax, nZmin, nZmax, zMinRatio, zMaxRatio)

!	hosS2V				: Surf2vol Class (Type)
!	hosType				: HOS Type (Ocean or NWT)
!	filePath			: HOS result file path (modes_HOS_SWENS.dat)
!	zMin, zMax 		: HOS grid z-minimum and z-maximul (vertical domain)
!	nZmin, nZmax 	: Number of z-directional Grid	
!
!	zMinRatio, zMaxRatio (Optional)
!	: Ratio of maximum and minimum height of grid (default=3)

! or 

Call hosS2V%initialize(dict)

!	hosS2V			: Surf2vol Class (Type)
!	dict				: HOS dictionary to initialize HOS surf2vol (Type)
\end{lstlisting}		

\vspace{0.5cm}	

\hspace{0.5 cm} -- Correct \texttt{Surf2Vol}

\begin{lstlisting}[language={[95]Fortran}]

Call hosS2V%correct(hosIndex)

!	hosS2V				: Surf2vol Class (Type)
!	hosIndex			: HOS time index
\end{lstlisting}		

\vspace{0.5cm}	

\hspace{0.5 cm} -- Data access on wave field of \texttt{Surf2Vol}

\hspace{1.0 cm} $\circ$ Wave elevation 

\begin{lstlisting}[language={[95]Fortran}]

eta = hosS2V%ptrHOSMesh_%eta(ix, iy)

!	hosS2V				: Surf2vol class (Type)
!	ix, iy				: HOS grid index (x, y)
!	eta						: Wave elevation
\end{lstlisting}	

\hspace{1.0 cm} $\circ$ Wave velocity

\begin{lstlisting}[language=bash]

u = hosS2V%ptrHOSMesh_%eta(ix, iy, iz)
v = hosS2V%ptrHOSMesh_%eta(ix, iy, iz)
w = hosS2V%ptrHOSMesh_%eta(ix, iy, iz)

!	hosS2V				: Surf2vol class (Type)
!	ix, iy, iz		: HOS grid index (x, y, z)
!	u, v, w				: Wave velocity (x, y, z)
\end{lstlisting}	

\pagebreak

\hspace{1.0 cm} $\circ$ Dynamic pressure ($p_d = p - \rho g z$)

\begin{lstlisting}[language={[95]Fortran}]

pd = hosS2V%ptrHOSMesh_%pd(ix, iy, iz)

!	hosS2V				: Surf2Vol class (Type)
!	ix, iy, iz		: HOS grid index (x, y, z)
!	pd						: Dynamic pressure
\end{lstlisting}	

\vspace{0.5cm}	

\hspace{0.5 cm} -- Destruct of \texttt{Surf2Vol}

\begin{lstlisting}[language={[95]Fortran}]

Call hosS2V%destroy()

!	hosS2V				: Surf2Vol class (Type)
\end{lstlisting}


