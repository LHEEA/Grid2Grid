\pagebreak	
\subsection{typSurf2Vol}

\subsubsection{Description}

\texttt{Surf2Vol} is wrapper class to access HOS Ocean and NWT class. Functionality and data of both HOS classes are similar but the mathematical formulation and meshes are a little bit different. Therefore the flow information from each HOS grid is only taken by using HOS mesh base class and transfer it to \texttt{Vol2Vol} Class. It is reminded that the direct access on the HOS wave fields is only possible by HOS mesh pointer to prevent misuse of HOS wave data. 

\texttt{Surf2Vol} class structure is depicted in Fig. \ref{fig:surf2VolStructure}. \texttt{Surf2Vol} class contains \texttt{HOSOceanSurf2Vol} and \texttt{HOSNWTSurf2Vol} classes. When the functionality is called, it calls the functionality of sub-class distiguished by HOS type. When the subroutine \texttt{correct} is called, the sub-class reads HOS modes from HOS result file and conducts $H_2$ operation to re-construct wave fields. Reconstructed wave field is saved on derived HOS grid class. And the HOS grid pointer at \texttt{Surf2Vol} points to derived HOS grid class to access wave fields. 

\vspace{0.5cm}
{
	\begin{figure} [H]
		\centering
		\includegraphics[scale=0.78]{images/c1.structure/"Surf2VolClassStructure".png}
		\vspace{0.5cm}
		\caption{\texttt{Surf2Vol} class structure}
		\label{fig:surf2VolStructure}
	\end{figure}
}

\pagebreak

\texttt{hosNWTSurf2Vol} and \texttt{hosOceanSurf2Vol} classes reconstruct HOS wave fields from HOS result file by using the $H_2$ operator. Wave reconstruction and HOS wave theory is well explained in \cite{ducrozet2007} and \cite{ducrozet2012}. Each class constructs wave fields on derived HOS mesh class which can be pointed by HOS mesh base class. 

HOS wave theory is based on the superposition of base modes which satisfy Laplace equation, sea bottom and free surface boundary condition basically, the behavior of the mode function has an exponential profile. This exponential profile could magnify local modes which has high wave number above $z=0$. For high steepness waves, this property gives unnatural values closed to free surface, criterion to cut local mode is introduced as \eqref{eq:fnzCriterion}. 

{
	\begin{equation}
	\label{eq:fnzCriterion}
	f_{mn}(z) = \begin{cases}
	\dfrac{\cosh k_{mn}(z+H)}{\cosh k_{mn}H}  &  \text{if} \quad f_{mn}(z) < C_{f(z)} \\
	C_{f(z)}  &  \text{if} \quad f_{mn}(z) \geq C_{f(z)}
	\end{cases}
	\end{equation}
	\newline
	\centering
	where
	\begin{equation*}
	k_{mn}	\text{ : HOS mode wave number \quad  $z$ : HOS z-coordinates \quad $H$ :  water depth}
	\end{equation*} 
	\begin{equation*}
	C_{f(z)}  \text{ : $f_{mn}(z)$ function criterion value (default = 10) }
	\end{equation*}
}

The parameter $C_{f(z)}$ is set to the default value of  10 in \texttt{Grid2Grid}. If the local wave velocities generated by \texttt{Grid2Grid} are not sufficient, the parameter can be changed. The parameter is defined in \texttt{modGrid2GridType.f90} as a \texttt{FNZ\_VALUE}.

HOS result file only contains mode amplitudes computed at each HOS simulation time, the volumic grid should then be reconstructed from those modes. HOS does not need vertical grid information, so z-directional grid information should be given when HOS \texttt{surf2vol} is initialised. Constructed HOS grid is used for interpolation grid. 

To constuct the HOS grid, following information should be given.

\hspace{0.5 cm} $\circ$ \texttt{zMin}, \texttt{zMax}

\hspace{0.5 cm} $\circ$ \texttt{nZMin}, \texttt{nZMax}

\hspace{0.5 cm} $\circ$ \texttt{nZMinRatio}, \texttt{nZMaxRatio} [Optional]

where \texttt{zMin} and \texttt{zMax} is used to set $z$-directional domain and it should have negative and positive value. \texttt{nZMin} and \texttt{nZMax} are the number of $z$-directional grid. It is recommended to have at least 50-100 points for the interpolation. If a sufficient number of grid points is not given, the interpolation scheme could give strange values due to exponetial profile of $f_{mn}(z)$. \texttt{nZMinRatio} and \texttt{nZMaxRatio} are the ratio of maximum and minumum height of grid (${\Delta z_{max}}/{\Delta z_{min}} $). Minimum grid is located at $z=0$. Those are optional values set to be 3 as default.  The grid can be visualized by using ParaView. The VTK file is located at VTK/Grid2Grid/surf2volMesh.vtk.

\pagebreak
\subsubsection{Class (Type)}

\textbf{Class} : \texttt{Surf2Vol}

\hspace{0.5 cm} -- Data :

\hspace{1.0 cm} $\circ$ \texttt{hosNWTSurf2Vol\_} : HOS-NWT Surf2Vol Class

\hspace{1.0 cm} $\circ$ \texttt{hosOceanSurf2Vol\_} : HOS-Ocean Surf2Vol Class

\hspace{1.0 cm} $\circ$ \texttt{ptrHOSMesh\_} : HOS Mesh Pointer\\

\hspace{0.5 cm} -- Functionality :

\hspace{1.0 cm} $\circ$ \texttt{initialize} : Initialise HOS Surf2Vol class with HOS type, result file path, ...

\hspace{1.0 cm} $\circ$ \texttt{correct} : Update HOS wave fields

\hspace{1.0 cm} $\circ$ \texttt{destroy} : Class desroyer\\    

\vspace{0.1cm}

\textbf{Class} : \texttt{HOSOceanSurf2Vol} and \texttt{HOSNWTSurf2Vol}

\hspace{0.5 cm} -- Data :

\hspace{1.0 cm} $\circ$ \texttt{HOSfile} : HOS result file (\texttt{modes\_HOS\_SWENSE.dat})

\hspace{1.0 cm} $\circ$ \texttt{HOSmode} : HOS Ocean or NWT modes

\hspace{1.0 cm} $\circ$ \texttt{HOSmesh} : HOS Ocean or NWT mesh (Two are different)

\hspace{1.0 cm} $\circ$ \texttt{HOSfftw} : HOS FFT class for $H_2$ operator \\

\hspace{0.5 cm} -- Public Functionality :

\hspace{1.0 cm} $\circ$ \texttt{initialize} : Initialise HOS Ocean or NWT Surf2Vol with result file path, ...

\hspace{1.0 cm} $\circ$ \texttt{correct} : Update HOS Ocean or NWT wave fields

\hspace{1.0 cm} $\circ$ \texttt{destroy} : Class desroyer\\

\hspace{0.5 cm} -- Private Functionality :

\hspace{1.0 cm} $\circ$ \texttt{init\_read\_mod} : Read HOS number of modes and allocate dynamic array

\hspace{1.0 cm} $\circ$ \texttt{read\_mod} : Read HOS modes for given HOS time index

\hspace{1.0 cm} $\circ$ \texttt{buildGlobalMesh} : Build HOS mesh with given HOS construction parameter

\hspace{1.0 cm} $\circ$ \texttt{reconstuctionFFTs} : Reconstruct wave fields by inverse $H_2$ operator \\

\subsubsection{How to use}

\hspace{0.5 cm} -- Initialise \texttt{Surf2Vol}

\begin{lstlisting}[language={[95]Fortran}]

Call hosS2V%initialize(hosType, filePath, zMin, zMax, nZmin, nZmax, zMinRatio, zMaxRatio)

!	hosS2V				: Surf2vol Class (Type)
!	hosType				: HOS Type (Ocean or NWT)
!	filePath			: HOS result file path (modes_HOS_SWENS.dat)
!	zMin, zMax 		: HOS grid z-minimum and z-maximul (vertical domain)
!	nZmin, nZmax 	: Number of z-directional Grid	
!
!	zMinRatio, zMaxRatio (Optional)
!	: Ratio of maximum and minimum height of grid (default=3)
\end{lstlisting}		

\vspace{0.5cm}	

\hspace{0.5 cm} -- Correct \texttt{Surf2Vol}

\begin{lstlisting}[language={[95]Fortran}]

Call hosS2V%correct(hosIndex)

!	hosS2V				: Surf2vol Class (Type)
!	hosIndex			: HOS time index
\end{lstlisting}		

\vspace{0.5cm}	

\hspace{0.5 cm} -- Data access on wave field of \texttt{Surf2Vol}

\hspace{1.0 cm} $\circ$ Wave elevation 

\begin{lstlisting}[language={[95]Fortran}]

eta = hosS2V%ptrHOSMesh_%eta(ix, iy)

!	hosS2V				: Surf2vol class (Type)
!	ix, iy				: HOS grid index (x, y)
!	eta						: Wave elevation
\end{lstlisting}	

\hspace{1.0 cm} $\circ$ Wave velocity

\begin{lstlisting}[language=bash]

u = hosS2V%ptrHOSMesh_%eta(ix, iy, iz)
v = hosS2V%ptrHOSMesh_%eta(ix, iy, iz)
w = hosS2V%ptrHOSMesh_%eta(ix, iy, iz)

!	hosS2V				: Surf2vol class (Type)
!	ix, iy, iz		: HOS grid index (x, y, z)
!	u, v, w				: Wave velocity (x, y, z)
\end{lstlisting}	

\pagebreak

\hspace{1.0 cm} $\circ$ Dynamic pressure ($p_d = p - \rho g z$)

\begin{lstlisting}[language={[95]Fortran}]

pd = hosS2V%ptrHOSMesh_%pd(ix, iy, iz)

!	hosS2V				: Surf2Vol class (Type)
!	ix, iy, iz		: HOS grid index (x, y, z)
!	pd						: Dynamic pressure
\end{lstlisting}	

\vspace{0.5cm}	

\hspace{0.5 cm} -- Destruct of \texttt{Surf2Vol}

\begin{lstlisting}[language={[95]Fortran}]

Call hosS2V%destroy()

!	hosS2V				: Surf2Vol class (Type)
\end{lstlisting}


